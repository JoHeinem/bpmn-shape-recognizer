<body style="margin: 0;">
  <canvas style="height: 50vh; width: 100vw; background-color: lightgray;"></canvas>
  <div style="height: 50vh; width: 100vw; background-color: lightblue;"></div>
  <div style="position: absolute; top: 50vh; height: 50vh; width: 100vw;"></div>
  <button style="background-color: gray; width: 50px; height: 20px; position: absolute; top: 0;"></button>
  <script src="frontend/bpmn-viewer.js"></script>
  <script>
    const canvas = document.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let erase = false;

    canvas.setAttribute('width', canvas.clientWidth);
    canvas.setAttribute('height', canvas.clientHeight);

    ctx.strokeStyle = 'black';
    ctx.lineWidth = 4;
    ctx.fillStyle = 'white';

    ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);

    canvas.addEventListener('mousedown', evt => {
      evt.preventDefault();
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(evt.clientX, evt.clientY);
    });

    canvas.addEventListener('mousemove', evt => {
      if (isDrawing) {
        ctx.lineTo(evt.clientX, evt.clientY);
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', async evt => {
      isDrawing = false;
      ctx.stroke();

      const png = canvas.toDataURL('image/png').substr(22);

      const resp = await fetch('http://192.168.178.44:1337/api/image-to-bpmn', {
        method: "POST", // *GET, POST, PUT, DELETE, etc.
        mode: "cors", // no-cors, cors, *same-origin
        body: png
      });
      const json = await resp.json();

      document.querySelector('div').innerHTML = '';

      const viewer = new BpmnJS({ container: 'div' });
      const modeling = viewer.get('modeling');
      const factory = viewer.get('elementFactory');
      const bpmnCanvas = viewer.get('canvas');

      function makeElement(props, root) {
        bpmnCanvas.addShape(factory.createShape(props), root, 0);
      }
      function makeConnection(props, root) {
        bpmnCanvas.addConnection(factory.createConnection(props), root, 0);
      }

      const root = factory.createRoot({ type: 'bpmn:Process' });
      bpmnCanvas.setRootElement(root, true);

      for (key in json) {
        if (json[key].type === 'bpmn:SequenceFlow') {
          makeConnection(json[key], root);
        } else {
          makeElement(json[key], root);
        }
      }

      bpmnCanvas.resized();
      bpmnCanvas.zoom('fit-viewport', 'auto');
    });

    document.querySelector('button').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.querySelector('div').innerHTML = '';
    })
  </script>
</body>
